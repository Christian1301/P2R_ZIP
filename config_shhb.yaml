# ============================================================
# CONFIG SHHB 
# ============================================================

RUN_NAME: "shhab"
EXPERIMENT_DIR: "exp"

# ============================================================
# DATASET
# ============================================================
DATASET:
  NAME: "shhb"   # Dataset ShanghaiTech Part B
  ROOT: "/home/C.ROMANO50/datasets/content/ShangaiTech-B"
  BLOCK_SIZE: 16
  NUM_WORKERS: 4

# ============================================================
# MODEL
# ============================================================
MODEL:
  BACKBONE: "vgg16_bn"
  BACKBONE_PRETRAINED: true
  
  FREEZE_BACKBONE_STAGE1: false
  FREEZE_BACKBONE_STAGE2: false
  FREEZE_BACKBONE_STAGE3: false
  
  ZIP_HIDDEN_DIM: 256
  ZIP_PI_THRESH: 0.2    
  
  P2R_FEA_CHANNEL: 256
  P2R_OUT_STRIDE: 16

ZIP_HEAD:
  LAMBDA_SCALE: 1.2
  LAMBDA_MAX: 8.0
  USE_SOFTPLUS: true

# ============================================================
# STAGE 1 & 2 
# ============================================================
OPTIM_ZIP:
  EPOCHS: 3000
  BATCH_SIZE: 8
  LR: 1.0e-4
  LR_BACKBONE: 1.0e-5
  HEAD_LR: 1.0e-4
  WEIGHT_DECAY: 1.0e-4
  WARMUP_EPOCHS: 50
  EARLY_STOPPING_PATIENCE: 1000
  GRAD_CLIP: 1.0
  VAL_INTERVAL: 5
  NUM_WORKERS: 4

ZIP_LOSS_V4:
  WEIGHT_NLL: 1.0
  WEIGHT_LAMBDA_REG: 0.01
  WEIGHT_PI_ENTROPY: 0.0
  LAMBDA_MAX_TARGET: 8.0
  OCCUPANCY_THRESHOLD: 0.5
  PI_THRESHOLD: 0.5

OPTIM_P2R:
  EPOCHS: 3000
  BATCH_SIZE: 8
  LR: 5.0e-5
  LR_BACKBONE: 1.0e-6
  WEIGHT_DECAY: 1.0e-2
  WARMUP_EPOCHS: 50
  EARLY_STOPPING_PATIENCE: 500
  GRAD_CLIP: 1.0
  SCHEDULER: "cosine"
  MIN_LR: 1.0e-7
  DROPOUT: 0.3
  FINAL_DROPOUT: 0.5
  USE_AGGRESSIVE_AUG: true
  AUG_SCALE_RANGE: [0.8, 1.2]
  AUG_ROTATION: 15
  AUG_ERASING_PROB: 0.3

P2R_LOSS:
  USE_MULTI_SCALE: true
  SCALES: [1, 2, 4]
  SCALE_WEIGHTS: [1.0, 0.5, 0.25]
  COUNT_WEIGHT: 2.0
  SPATIAL_WEIGHT: 0.15
  SCALE_WEIGHT: 0.5
  LOG_SCALE_INIT: 4.0
  LOG_SCALE_CLAMP: [-2.0, 10.0]
  LOG_SCALE_LR_MULT: 0.1

# ============================================================
# STAGE 3: Joint Training - PARAMETRI CRITICI MODIFICATI
# ============================================================
OPTIM_JOINT:
  BATCH_SIZE: 8

STAGE3_FUSION:
  ALPHA_START: 0.0
  ALPHA_END: 0.1        
  ALPHA_WARMUP: 20      
  LR_P2R: 0.0          
  LR_SCALE: 1.0e-3
  SPATIAL_WEIGHT: 0.0   
  EPOCHS: 150      
  PATIENCE: 80

JOINT_LOSS:
  COUNT_WEIGHT: 1.0
  MASK_WEIGHT: 0.0
  USE_SOFT_MASK: true
  SOFT_ALPHA: 0.1     
  FREEZE_ZIP_HEAD: true
  FREEZE_P2R_BACKBONE_ONLY: true

# ============================================================
# AUGMENTATION
# ============================================================
AUGMENTATION:
  TRAIN:
    RANDOM_CROP: true
    CROP_SIZE: [512, 512]  
    HORIZONTAL_FLIP: true
    FLIP_PROB: 0.5
    COLOR_JITTER: true
    JITTER_BRIGHTNESS: 0.2
    JITTER_CONTRAST: 0.2
    JITTER_SATURATION: 0.1
    JITTER_HUE: 0.05
    RANDOM_GRAYSCALE: true
    GRAYSCALE_PROB: 0.1
    GAUSSIAN_BLUR: true
    BLUR_PROB: 0.1
    BLUR_KERNEL: [3, 7]
  VAL:
    RESIZE: false  

# ============================================================
# Logging
# ============================================================
LOGGING:
  LOG_INTERVAL: 50
  VAL_INTERVAL: 1
  SAVE_BEST_ONLY: true
  TENSORBOARD: true

EXP:
  OUT_DIR: "exp"

DEVICE: "cuda"
SEED: 42