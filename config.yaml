# =================================================================
# CONFIGURAZIONE P2R-ZIP - V4 High Recall π-head
# =================================================================
# Modifiche rispetto a V3:
# 1. PI_POS_WEIGHT 15 → 25 (penalizza di più i falsi negativi)
# 2. OCCUPANCY_THRESHOLD 0.5 → 0.3 (cattura più regioni sparse)
# 3. EARLY_STOPPING_PATIENCE 80 → 40 (ferma prima l'overfitting)
# 4. LR_HEADS 5e-5 → 3e-5 (training più stabile)
# 5. Aggiunto RECALL_TARGET_WEIGHT per loss ausiliaria

RUN_NAME: "shha_target60_v3"
SEED: 2025
DEVICE: "cuda"

# === DATASET ===
DATASET: "shha"
DATA:
  ROOT: "/mnt/localstorage/cromano/Datasets/ShanghaiTech/part_A"
  ZIP_BLOCK_SIZE: 16
  P2R_DOWNSAMPLE: 8
  IMG_EXTS: [".jpg", ".png"]
  NORM_MEAN: [0.485, 0.456, 0.406]
  NORM_STD:  [0.229, 0.224, 0.225]
  TRAIN_SPLIT: "train_data"
  VAL_SPLIT: "val_data"
  CROP_SIZE: 384
  CROP_SCALE: [0.7, 1.0]

# === MODELLO ===
MODEL:
  BACKBONE: "vgg16_bn"
  ZIP_PI_THRESH: 0.5          
  GATE: "multiply"
  UPSAMPLE_TO_INPUT: false

# === ZIP HEAD CONFIGURATION ===
ZIP_HEAD:
  LAMBDA_SCALE: 1.2
  LAMBDA_MAX: 8.0
  USE_SOFTPLUS: true
  LAMBDA_NOISE_STD: 0.0

# -----------------------------------------------------------------
# STAGE 1: ZIP TRAINING (invariato)
# -----------------------------------------------------------------
OPTIM_ZIP:
  BATCH_SIZE: 6
  NUM_WORKERS: 4
  EPOCHS: 2000
  WEIGHT_DECAY: 3.0e-5
  SCHEDULER: "cosine"
  VAL_INTERVAL: 5
  RESUME_LAST: true
  SAVE_BEST: true
  BASE_LR: 8.0e-5
  LR_BACKBONE: 4.0e-5
  WARMUP_EPOCHS: 100
  EARLY_STOPPING_PATIENCE: 500
  EARLY_STOPPING_DELTA: 0.001

ZIP_LOSS:
  WEIGHT_CE: 1.5
  WEIGHT_NLL: 1.0
  WEIGHT_COUNT: 0.8
  WEIGHT_ALIGN: 0.4
  POS_WEIGHT_BCE: 5.0

ZIP_REG:
  PI_TARGET: 0.15
  PI_WEIGHT: 5.0e-4
  LAMBDA_TARGET: 5.0
  LAMBDA_WEIGHT: 1.0e-4

# -----------------------------------------------------------------
# STAGE 2: P2R TRAINING (invariato)
# -----------------------------------------------------------------
OPTIM_P2R:
  BATCH_SIZE: 8
  NUM_WORKERS: 4
  EPOCHS: 1500
  LR: 1.0e-4
  LR_BACKBONE: 0.0
  WEIGHT_DECAY: 1.0e-4
  SCHEDULER: "cosine"
  VAL_INTERVAL: 5            
  RESUME_LAST: true
  SAVE_BEST: true
  EARLY_STOPPING_PATIENCE: 50
  EARLY_STOPPING_DELTA: 0.5      

P2R_LOSS:
  COUNT_WEIGHT: 2.0
  SCALE_WEIGHT: 0.5
  SPATIAL_WEIGHT: 0.1
  MIN_RADIUS: 8.0
  MAX_RADIUS: 64.0
  CHUNK_SIZE: 2048
  LOG_SCALE_INIT: 4.0
  LOG_SCALE_CLAMP: [-2.0, 10.0]
  LOG_SCALE_CALIBRATION_MAX_DELTA: 3.0
  CALIBRATE_BATCHES: 10

# -----------------------------------------------------------------
# STAGE 3: JOINT TRAINING - V4 HIGH RECALL
# -----------------------------------------------------------------
# Obiettivo: π-head con recall > 98%
# Modifiche chiave:
# - PI_POS_WEIGHT aumentato (25 vs 15) → penalizza mascherare persone
# - OCCUPANCY_THRESHOLD ridotto (0.3 vs 0.5) → cattura scene sparse
# - Patience ridotta (40 vs 80) → ferma prima l'overfitting
# - LR ridotto (3e-5 vs 5e-5) → training più stabile
# -----------------------------------------------------------------
OPTIM_JOINT:
  BATCH_SIZE: 8
  NUM_WORKERS: 4
  EPOCHS: 800                   # Ridotto da 800 (overfitting dopo ~100 epoche)
  
  LR_BACKBONE: 0.0              # Congelato
  LR_HEADS: 3.0e-5              # Ridotto da 5e-5 per stabilità
  
  WEIGHT_DECAY: 1.0e-4
  SCHEDULER: "cosine"
  SCHEDULER_STEP: "epoch"     
  WARMUP_EPOCHS: 10             # Ridotto da 20
  LR_MIN_FACTOR: 0.01         
  
  VAL_INTERVAL: 5
  EARLY_STOPPING_PATIENCE: 80   # Ridotto da 80 (ferma overfitting prima)
  EARLY_STOPPING_DELTA: 0.3

JOINT_LOSS:
  # === Pesi Loss - Bilanciati per High Recall ===
  PI_WEIGHT: 0.8                # Aumentato da 0.5 (più supervisione π-head)
  COUNT_WEIGHT: 2.0             # Invariato (principale)
  SCALE_WEIGHT: 0.3             # Invariato
  SPATIAL_WEIGHT: 0.05          # Ridotto da 0.1 (meno focus sulla forma)
  
  # === π-head Parameters - HIGH RECALL ===
  PI_POS_WEIGHT: 25.0           # Aumentato da 15! Penalizza molto i falsi negativi
  OCCUPANCY_THRESHOLD: 0.3      # Ridotto da 0.5! Cattura anche blocchi con poche persone
  MASK_TEMPERATURE: 0.8         # Ridotto da 1.0 (maschera più sharp)
  
  # === Recall Target (NUOVO) ===
  # Se recall < 97%, aggiungi penalità
  RECALL_MIN_TARGET: 0.97
  RECALL_PENALTY_WEIGHT: 1.0
  
  # === Legacy ===
  ALPHA: 1.0
  ZIP_SCALE: 0.5

# -----------------------------------------------------------------
# STAGE 4: RECOVERY (opzionale, può non servire con V4)
# -----------------------------------------------------------------
OPTIM_STAGE4:
  BATCH_SIZE: 4               
  NUM_WORKERS: 4              
  EPOCHS: 500                   # Ridotto
  
  LR_BACKBONE: 0.0
  LR_HEADS: 1.0e-5
  
  WEIGHT_DECAY: 1.0e-4        
  SCHEDULER: "cosine"         
  SCHEDULER_STEP: "epoch"     
  WARMUP_EPOCHS: 5            
  VAL_INTERVAL: 3             
  EARLY_STOPPING_PATIENCE: 100

STAGE4_LOSS:
  ALPHA: 0.3
  ZIP_SCALE: 0.1
  COUNT_L1_W: 3.0

# === BIN CONFIGURATION ===
BINS_CONFIG:
  shha:
    bins: [[0, 0], [1, 3], [4, 6], [7, 10], [11, 15], [16, 22], [23, 32], [33, 9999]]
    bin_centers: [0.0, 2.0, 5.0, 8.5, 13.0, 19.0, 27.5, 45.0]
  shhb:
    bins: [[0, 0], [1, 1], [2, 2], [3, 3], [4, 4], [5, 5], [6, 6], [7, 7], [8, 8], [9, 9999]]
    bin_centers: [0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 10.16]
  qnrf:
    bins: [[0,0],[1,1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,7],[8,8],[9,9],[10,10],[11,12],[13,14],[15,16],[17,18],[19,20],[21,23],[24,26],[27,29],[30,33],[34,9999]]
    bin_centers: [0.0,1.0,2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0,10.0,11.43,13.43,15.44,17.44,19.43,21.83,24.85,27.87,31.24,38.86]
  nwpu:
    bins: [[0,0],[1,1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,7],[8,8],[9,9],[10,10],[11,12],[13,14],[15,16],[17,18],[19,20],[21,23],[24,26],[27,29],[30,33],[34,9999]]
    bin_centers: [0.0,1.0,2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0,10.0,11.43,13.43,15.44,17.44,19.43,21.83,24.85,27.87,31.24,38.86]

EXP:
  OUT_DIR: "exp"
  SAVE_BEST: true
  SAVE_WORST_CASES: true