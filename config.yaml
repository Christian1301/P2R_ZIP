# =================================================================
# CONFIGURAZIONE V8 - STAGE 2 POTENZIATO
# =================================================================
# 
# OBIETTIVO: Migliorare MAE 68.97 → target 63-66
#
# MODIFICHE DA V7:
# 1. Stage 2: 3000 → 5000 epoche
# 2. Early stopping patience: 120 → 200
# 3. Data augmentation più aggressiva:
#    - CROP_SCALE: [0.5, 1.0] → [0.4, 1.0]
#    - Color jitter aggiunto
#    - Random grayscale 10%
# 4. Warmup epochs per Stage 2
#
# RISULTATI V7:
# - Stage 2: MAE 68.97 (baseline da battere)
# =================================================================

RUN_NAME: "shha_target60_v8"
SEED: 2025
DEVICE: "cuda"

# === DATASET ===
DATASET: "shha"
DATA:
  ROOT: "/mnt/localstorage/cromano/Datasets/ShanghaiTech/part_A"
  ZIP_BLOCK_SIZE: 16
  P2R_DOWNSAMPLE: 8
  IMG_EXTS: [".jpg", ".png"]
  NORM_MEAN: [0.485, 0.456, 0.406]
  NORM_STD:  [0.229, 0.224, 0.225]
  TRAIN_SPLIT: "train_data"
  VAL_SPLIT: "val_data"
  
  # *** V8: Data Augmentation POTENZIATA ***
  CROP_SIZE: 384
  CROP_SCALE: [0.4, 1.0]        # Era [0.5, 1.0] - più variazione di scala
  
  # *** V8: Nuove augmentation ***
  COLOR_JITTER:
    ENABLED: true
    BRIGHTNESS: 0.2
    CONTRAST: 0.2
    SATURATION: 0.2
    HUE: 0.1
  HORIZONTAL_FLIP: true
  RANDOM_GRAY_PROB: 0.1         # 10% probabilità grayscale
  GAUSSIAN_BLUR:
    ENABLED: true
    PROB: 0.1
    KERNEL_SIZE: [3, 5]

# === MODELLO ===
MODEL:
  BACKBONE: "vgg16_bn"
  ZIP_PI_THRESH: 0.2
  GATE: "multiply"
  UPSAMPLE_TO_INPUT: false
  USE_STE_MASK: true

# === ZIP HEAD ===
ZIP_HEAD:
  LAMBDA_SCALE: 1.2
  LAMBDA_MAX: 8.0
  USE_SOFTPLUS: true
  LAMBDA_NOISE_STD: 0.0

# =================================================================
# STAGE 1 - ZIP PRE-TRAINING (come V7)
# =================================================================
OPTIM_ZIP:
  BATCH_SIZE: 6
  NUM_WORKERS: 4
  EPOCHS: 2500
  WEIGHT_DECAY: 3.0e-5
  SCHEDULER: "cosine"
  VAL_INTERVAL: 5
  RESUME_LAST: true
  SAVE_BEST: true
  BASE_LR: 8.0e-5
  LR_BACKBONE: 4.0e-5
  WARMUP_EPOCHS: 100
  EARLY_STOPPING_PATIENCE: 600

ZIP_LOSS:
  POS_WEIGHT_BCE: 5.0
  COUNT_WEIGHT: 0.65
  LAMBDA_REG_WEIGHT: 0.01
  OCCUPANCY_THRESHOLD: 0.5
  WEIGHT_CE: 1.5
  WEIGHT_NLL: 1.0
  WEIGHT_COUNT: 0.8
  WEIGHT_ALIGN: 0.4

ZIP_REG:
  PI_TARGET: 0.15
  PI_WEIGHT: 5.0e-4
  LAMBDA_TARGET: 5.0
  LAMBDA_WEIGHT: 1.0e-4

# =================================================================
# STAGE 2 - P2R TRAINING (MASSIMIZZATO V8)
# =================================================================
# Strategia: più epoche + augmentation aggressiva + patience alta
# =================================================================
OPTIM_P2R:
  BATCH_SIZE: 8
  NUM_WORKERS: 4
  
  # *** V8: MOLTO più epoche ***
  EPOCHS: 5000                  # Era 3000 in V7
  
  # LR stabile (come V7)
  LR: 5.0e-5
  LR_BACKBONE: 1.0e-6           # Fine-tuning leggero backbone
  
  WEIGHT_DECAY: 1.0e-4
  SCHEDULER: "cosine"
  VAL_INTERVAL: 5
  RESUME_LAST: true
  SAVE_BEST: true
  
  # *** V8: Warmup per stabilità iniziale ***
  WARMUP_EPOCHS: 50
  
  # *** V8: Patience MOLTO aumentata ***
  EARLY_STOPPING_PATIENCE: 200  # Era 120 in V7
  
  # *** V8: Gradient clipping per stabilità ***
  GRAD_CLIP: 1.0

P2R_LOSS:
  COUNT_WEIGHT: 2.0
  SCALE_WEIGHT: 0.5
  SPATIAL_WEIGHT: 0.15
  MIN_RADIUS: 8.0
  MAX_RADIUS: 64.0
  CHUNK_SIZE: 2048
  LOG_SCALE_INIT: 4.0
  LOG_SCALE_CLAMP: [-2.0, 10.0]
  LOG_SCALE_CALIBRATION_MAX_DELTA: 3.0
  CALIBRATE_BATCHES: 10

# =================================================================
# STAGE 3 - SOFT WEIGHTING (disabilitato - non funziona)
# =================================================================
OPTIM_STAGE3:
  ENABLED: false                # Disabilitato - Stage 2 è il finale
  BATCH_SIZE: 8
  NUM_WORKERS: 4
  EPOCHS: 300
  LR_BACKBONE: 0.0
  LR_HEADS: 5.0e-5
  WEIGHT_DECAY: 1.0e-4
  EARLY_STOPPING_PATIENCE: 60

STAGE3_LOSS:
  SOFT_WEIGHT_ALPHA: 0.3
  COUNT_WEIGHT: 1.0
  SPATIAL_WEIGHT: 0.1
  CONSISTENCY_WEIGHT: 0.2
  PI_SUPERVISION_WEIGHT: 0.15
  PI_POS_WEIGHT: 5.0

# =================================================================
# STAGE 4 - BIAS CORRECTION (opzionale)
# =================================================================
OPTIM_STAGE4:
  BATCH_SIZE: 4
  NUM_WORKERS: 4
  EPOCHS: 150
  LR_P2R: 1.0e-6
  LR_LOG_SCALE: 1.0e-5
  LR_PI: 1.0e-4
  WEIGHT_DECAY: 1.0e-4
  VAL_INTERVAL: 3
  EARLY_STOPPING_PATIENCE: 40

STAGE4_LOSS:
  OVERESTIMATE_WEIGHT: 2.0
  COUNT_WEIGHT: 1.0
  PI_WEIGHT: 0.3

# === BIN CONFIGURATION ===
BINS_CONFIG:
  shha:
    bins: [[0, 0], [1, 3], [4, 6], [7, 10], [11, 15], [16, 22], [23, 32], [33, 9999]]
    bin_centers: [0.0, 2.0, 5.0, 8.5, 13.0, 19.0, 27.5, 45.0]
 
EXP:
  OUT_DIR: "exp"
  SAVE_BEST: true
  SAVE_WORST_CASES: true