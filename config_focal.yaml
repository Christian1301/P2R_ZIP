RUN_NAME: "shha_p2rzip_v8_focal_v2"
SEED: 2025
DEVICE: "cuda"

# === DATASET ===
DATASET: "shha"
DATA:
  ROOT: "/home/C.ROMANO50/datasets/content/ShangaiTech-A"
  ZIP_BLOCK_SIZE: 16
  P2R_DOWNSAMPLE: 8
  IMG_EXTS: [".jpg", ".png"]
  NORM_MEAN: [0.485, 0.456, 0.406]
  NORM_STD:  [0.229, 0.224, 0.225]
  TRAIN_SPLIT: "train"
  VAL_SPLIT: "test"
  CROP_SIZE: 384

  # === AUGMENTATION POTENZIATA (Anti-Overfitting) ===
  AUGMENTATION:
    RandomResizedCrop:
      ENABLED: true
      SCALE: [0.5, 2.5]      # Più aggressivo (era [0.75, 2.0])
      RATIO: [0.6, 1.67]     # Più variazione
    HorizontalFlip:
      ENABLED: true
      PROB: 0.5
    COLOR_JITTER:
      ENABLED: true
      BRIGHTNESS: 0.4        # Aumentato
      CONTRAST: 0.4
      SATURATION: 0.3
      HUE: 0.15
    RANDOM_GRAY_PROB: 0.2    # Aggiunto
    GAUSSIAN_BLUR:
      ENABLED: true
      PROB: 0.3              # Aumentato
      KERNEL_SIZE: [3, 5, 7]

# === MODELLO ===
MODEL:
  BACKBONE: "vgg16_bn"
  ZIP_PI_THRESH: 0.3
  GATE: "multiply"
  UPSAMPLE_TO_INPUT: false
  USE_STE_MASK: true

# === ZIP HEAD ===
ZIP_HEAD:
  LAMBDA_SCALE: 1.2
  LAMBDA_MAX: 8.0
  USE_SOFTPLUS: true
  LAMBDA_NOISE_STD: 0.0

# =================================================================
# STAGE 1 - ZIP PRE-TRAINING (INVARIATO - già completato)
# =================================================================
OPTIM_ZIP:
  BATCH_SIZE: 6
  NUM_WORKERS: 4
  EPOCHS: 2000
  WEIGHT_DECAY: 1.0e-4
  SCHEDULER: "cosine"
  RESUME_LAST: true 
  VAL_INTERVAL: 5
  BASE_LR: 8.0e-5
  LR_BACKBONE: 4.0e-5
  WARMUP_EPOCHS: 100
  EARLY_STOPPING_PATIENCE: 1000

ZIP_LOSS:
  POS_WEIGHT_BCE: 1.5
  POLARIZATION_WEIGHT: 1.5
  COUNT_WEIGHT: 0.2
  LAMBDA_REG_WEIGHT: 0.01
  OCCUPANCY_THRESHOLD: 0.5

# =================================================================
# STAGE 2 - P2R TRAINING (ANTI-OVERFITTING)
# =================================================================
# 
# PROBLEMA OSSERVATO:
#   Epoch 1445: Train MAE=15, Val MAE=112 → Gap 7.5x (overfitting grave)
#   Best Val MAE: 100.86 (raggiunto molto prima, poi degradato)
#
# MODIFICHE:
#   1. LR ridotto: 5e-5 → 1.5e-5
#   2. Backbone FREEZE completo (LR=0)
#   3. Weight decay 8x più forte
#   4. Early stopping aggressivo (200 vs 1200)
#   5. Meno epoche (800 vs 4000)
#   6. Batch size aumentato per stabilità
#
# =================================================================
OPTIM_P2R:
  BATCH_SIZE: 12             # Aumentato da 8
  NUM_WORKERS: 4
  EPOCHS: 800                # Ridotto da 4000
  LR: 1.5e-5                 # Ridotto da 5.0e-5
  LR_BACKBONE: 0             # FREEZE completo (era 1.0e-6)
  WEIGHT_DECAY: 8.0e-4       # Aumentato da 1.0e-4
  SCHEDULER: "cosine"
  VAL_INTERVAL: 5
  RESUME_LAST: false         # IMPORTANTE: false per ripartire da zero
  SAVE_BEST: true
  WARMUP_EPOCHS: 30          # Ridotto da 50
  EARLY_STOPPING_PATIENCE: 200  # Ridotto da 1200
  GRAD_CLIP: 0.5             # Più stretto (era 1.0)

P2R_LOSS:
  USE_MULTI_SCALE: true
  SCALES: [1, 2, 4]
  SCALE_WEIGHTS: [1.0, 0.5, 0.25]
  COUNT_WEIGHT: 2.0
  SCALE_WEIGHT: 0.5
  SPATIAL_WEIGHT: 0.1        # Ridotto da 0.15
  MIN_RADIUS: 8.0
  MAX_RADIUS: 64.0
  CHUNK_SIZE: 2048
  LOG_SCALE_INIT: 2.5
  LOG_SCALE_CLAMP: [-2.0, 10.0]
  LOG_SCALE_CALIBRATION_MAX_DELTA: 3.0
  CALIBRATE_BATCHES: 10

# =================================================================
# STAGE 3 - JOINT TRAINING (Anti-Overfitting)
# =================================================================
OPTIM_JOINT:
  BATCH_SIZE: 6   
  NUM_WORKERS: 4
  EPOCHS: 300
  LR_BACKBONE: 0            
  LR_HEADS: 5.0e-6
  WEIGHT_DECAY: 5.0e-4
  VAL_INTERVAL: 5
  EARLY_STOPPING_PATIENCE: 100
  GRAD_CLIP: 0.5
  WARMUP_EPOCHS: 10

JOINT_LOSS:
  FIXED_ZIP_WEIGHT: 0.1     
  FIXED_P2R_WEIGHT: 1.0     
  USE_SOFT_WEIGHTING: false 

# === BINS CONFIG ===
BINS_CONFIG:
  shha:
    bins: [[0, 0], [1, 3], [4, 6], [7, 10], [11, 15], [16, 22], [23, 32], [33, 9999]]
    bin_centers: [0.0, 2.0, 5.0, 8.5, 13.0, 19.0, 27.5, 45.0]
  shhb:
    bins: [[0, 0], [1, 1], [2, 2], [3, 3], [4, 4], [5, 5], [6, 6], [7, 7], [8, 8], [9, 9999]]
    bin_centers: [0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 10.16]
  qnrf:
    bins: [[0,0],[1,1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,7],[8,8],[9,9],[10,10],[11,12],[13,14],[15,16],[17,18],[19,20],[21,23],[24,26],[27,29],[30,33],[34,9999]]
    bin_centers: [0.0,1.0,2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0,10.0,11.43,13.43,15.44,17.44,19.43,21.83,24.85,27.87,31.24,38.86]
  nwpu:
    bins: [[0,0],[1,1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,7],[8,8],[9,9],[10,10],[11,12],[13,14],[15,16],[17,18],[19,20],[21,23],[24,26],[27,29],[30,33],[34,9999]]
    bin_centers: [0.0,1.0,2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0,10.0,11.43,13.43,15.44,17.44,19.43,21.83,24.85,27.87,31.24,38.86]

EXP:
  OUT_DIR: "exp"
  SAVE_BEST: true
  SAVE_WORST_CASES: true