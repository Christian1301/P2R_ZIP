# ========================================
# CONFIG 2 — MASSIMA PERFORMANCE
# (Il validation VIENE incluso nel training)
# ========================================

RUN_NAME: "shha_max_perf"
SEED: 2025
DEVICE: "cuda"

DATASET: "shha"
DATA:
  ROOT: "/mnt/localstorage/cromano/Datasets/ShanghaiTech/part_A"
  ZIP_BLOCK_SIZE: 16
  IMG_EXTS: [".jpg", ".png"]
  NORM_MEAN: [0.485, 0.456, 0.406]
  NORM_STD:  [0.229, 0.224, 0.225]

  # *** VALIDATION FUSO NEL TRAIN ***
  TRAIN_SPLIT: ["train_data", "val_data"]
  VAL_SPLIT: "val_data"

  CROP_SIZE: 256
  CROP_SCALE: [0.75, 2.0]

  CROP_SIZE_STAGE1: 448
  CROP_SCALE_STAGE1: [0.75, 2.0]

  CROP_SIZE_STAGE2: 256
  CROP_SCALE_STAGE2: [0.75, 2.0]

  COUNT_SAMPLER:
    ENABLE: true
    BASE_WEIGHT: 1.0
    POWER: 1.35
    LOG_OFFSET: 1.0

  SCENE_AWARE_CROP:
    ENABLE: true
    DENSE_POINT_THRESHOLD: 600
    KEEP_RATIO: 0.65
    MAX_ATTEMPTS: 8

# === MODEL ===
MODEL:
  BACKBONE: "vgg16_bn"
  ZIP_PI_THRESH: 0.12
  GATE: "multiply"
  UPSAMPLE_TO_INPUT: true
  ZIP_PI_SOFT: true
  ZIP_PI_SOFT_MIN: 0.05
  ZIP_PI_SOFT_POWER: 1.0
  ZIP_PI_APPLY_TO_P2R: false

ZIP_HEAD:
  LAMBDA_SCALE: 0.5
  LAMBDA_MAX: 3.2
  USE_SOFTPLUS: true
  LAMBDA_NOISE_STD: 0.0

# === STAGE 1 ===
OPTIM_ZIP:
  BATCH_SIZE: 8
  NUM_WORKERS: 4
  EPOCHS: 1300
  WEIGHT_DECAY: 1e-4
  SCHEDULER: "cosine"
  WARMUP_EPOCHS: 10
  LR_MIN_FACTOR: 0.05
  VAL_INTERVAL: 2
  RESUME_LAST: true
  SAVE_BEST: true
  EARLY_STOPPING_PATIENCE: 200
  CLIP_GRAD_NORM: 1.0
  BASE_LR: 1e-4
  LR_BACKBONE: 1e-4

ZIP_LOSS:
  WEIGHT_CE: 3.2
  WEIGHT_NLL: 1.0
  WEIGHT_COUNT: 0.25

ZIP_REG:
  PI_TARGET: 0.30
  PI_WEIGHT: 6e-3
  LAMBDA_TARGET: 1.0
  LAMBDA_WEIGHT: 0.0
  COUNT_WEIGHT: 0.0

# === STAGE 2 (P2R) ===
OPTIM_P2R:
  BATCH_SIZE: 16
  NUM_WORKERS: 4
  EPOCHS: 1800
  LR: 7e-5
  FINETUNE_BACKBONE: true
  LR_BACKBONE: 1e-5
  WEIGHT_DECAY: 1e-4
  SCHEDULER: "cosine"
  VAL_INTERVAL: 10
  EXTRA_VAL_EPOCHS: [100]
  RESUME_LAST: true
  SAVE_BEST: true
  EARLY_STOPPING_PATIENCE: 200

P2R_LOSS:
  MU: 128
  TAU: 8
  POS_WEIGHT: 5.0
  SCALE_WEIGHT: 1e-3
  SCALE_PENALTY_HUBER_DELTA: 120.0
  SCALE_PENALTY_CAP: 800.0
  SCALE_PENALTY_NORM: "sqrt_gt"
  COUNT_L1_WEIGHT: 1.40
  DENSITY_L1_WEIGHT: 3e-3
  LOG_SCALE_INIT: -2.5
  LOG_SCALE_CLAMP: [-6.0, -1.8]
  LOG_SCALE_DYNAMIC_FLOOR: -6.0

P2R_DIAGNOSTICS:
  ENABLE: true
  COUNT_ERR_THRESHOLD: 250.0
  TOPK: 6

# HARD REPLAY — INCLUDE LE SCENE PIÙ DIFFICILI DEL VAL
P2R_HARD_REPLAY:
  ENABLE: true
  IMAGES:
    - "part_A/val_data/images/IMG_19.jpg"
    - "part_A/val_data/images/IMG_39.jpg"
    - "part_A/val_data/images/IMG_66.jpg"
    - "part_A/val_data/images/IMG_143.jpg"
    - "part_A/val_data/images/IMG_247.jpg"
    - "part_A/val_data/images/IMG_267.jpg"
  REPEAT_FACTOR: 6
  AUTO_DENSE:
    ENABLE: true
    MIN_POINTS: 600
    MAX_SAMPLES: 96
    REPEAT_FACTOR: 6

P2R_SCENE_PRIORITIES:
  ENABLE: true
  TARGETS:
    - match: "IMG_19"
      count_weight: 3.0
    - match: "IMG_39"
      count_weight: 3.0
    - match: "IMG_143"
      count_weight: 3.0
    - match: "IMG_267"
      count_weight: 3.0

# === STAGE 3 ===
OPTIM_JOINT:
  BATCH_SIZE: 8
  NUM_WORKERS: 4
  EPOCHS: 900
  LR_HEADS: 4e-5
  LR_BACKBONE: 1e-5
  WEIGHT_DECAY: 1e-4
  SCHEDULER: "cosine"
  WARMUP_EPOCHS: 5
  WARMUP_P2R_EPOCHS: 100
  LR_MIN_FACTOR: 0.02
  LOAD_STAGE3_BEST: false
  EARLY_STOPPING_PATIENCE: 200
  VAL_INTERVAL: 5
  RESUME_LAST: true
  SAVE_BEST: true

JOINT_LOSS:
  ALPHA: 2.0
  ZIP_SCALE: 0.0
  COUNT_L1_W: 0.30
  P2R_COUNT_L1_W: 1.7
  DENSITY_L1_W: 1e-3

# === BINS ===
BINS_CONFIG:
  shha:
    bins:
      - [0,0]
      - [1,1]
      - [2,2]
      - [3,3]
      - [4,4]
      - [5,5]
      - [6,6]
      - [7,7]
      - [8,8]
      - [9,9]
      - [10,10]
      - [11,12]
      - [13,14]
      - [15,9999]
    bin_centers: [0.0,1.0,2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0,10.0,11.38,13.38,16.26]

EXP:
  OUT_DIR: "exp"
  SAVE_BEST: true
