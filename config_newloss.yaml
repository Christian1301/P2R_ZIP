# =================================================================
# CONFIG P2R-ZIP V2 - Con P2R Head BINARIO
# =================================================================
# 
# Questa configurazione usa l'architettura P2R originale:
# - P2R head con 2 canali â†’ differenza (output binario)
# - Conteggio = (logits > 0).count()
# - P2RLoss con matching point-to-region
#
# =================================================================

# Versione modello: "v1" (density continua) o "v2" (binario come paper P2R)
MODEL_VERSION: "v2"

RUN_NAME: "shha_p2rzip_binary"
SEED: 2025
DEVICE: "cuda"

# === DATASET ===
DATASET: "shha"
DATA:
  ROOT: "/home/C.ROMANO50/datasets/content/ShangaiTech-A"
  ZIP_BLOCK_SIZE: 16
  P2R_DOWNSAMPLE: 16  # VGG/32 * upscale2 = /16
  IMG_EXTS: [".jpg", ".png"]
  NORM_MEAN: [0.485, 0.456, 0.406]
  NORM_STD:  [0.229, 0.224, 0.225]
  TRAIN_SPLIT: "train"
  VAL_SPLIT: "test"
  CROP_SIZE: 256  # Come paper P2R originale

  # === AUGMENTATION (come paper P2R) ===
  AUGMENTATION:
    RandomResizedCrop:
      ENABLED: true
      SCALE: [0.7, 1.3]
      RATIO: [0.75, 1.33]
    HorizontalFlip:
      ENABLED: true
      PROB: 0.5
    COLOR_JITTER:
      ENABLED: true
      BRIGHTNESS: 0.4
      CONTRAST: 0.4
      SATURATION: 0.4
      HUE: 0.1
    RANDOM_GRAY_PROB: 0.25
    GAUSSIAN_BLUR:
      ENABLED: true
      PROB: 0.8
      KERNEL_SIZE: [3, 5]

# === MODELLO ===
MODEL:
  BACKBONE: "vgg16_bn"
  ZIP_PI_THRESH: 0.3
  USE_STE_MASK: true

# === ZIP HEAD ===
ZIP_HEAD:
  LAMBDA_SCALE: 1.2
  LAMBDA_MAX: 8.0
  USE_SOFTPLUS: true
  LAMBDA_NOISE_STD: 0.0

# =================================================================
# STAGE 1 - ZIP PRE-TRAINING (invariato)
# =================================================================
OPTIM_ZIP:
  BATCH_SIZE: 6
  NUM_WORKERS: 4
  EPOCHS: 2000
  WEIGHT_DECAY: 1.0e-4
  SCHEDULER: "cosine"
  RESUME_LAST: true 
  VAL_INTERVAL: 5
  BASE_LR: 8.0e-5
  LR_BACKBONE: 4.0e-5
  WARMUP_EPOCHS: 100
  EARLY_STOPPING_PATIENCE: 1000

ZIP_LOSS:
  POS_WEIGHT_BCE: 1.5
  POLARIZATION_WEIGHT: 1.5
  COUNT_WEIGHT: 0.2
  LAMBDA_REG_WEIGHT: 0.01
  OCCUPANCY_THRESHOLD: 0.5

# =================================================================
# STAGE 2 - P2R BINARIO (come paper originale)
# =================================================================
OPTIM_P2R:
  BATCH_SIZE: 16
  NUM_WORKERS: 4
  EPOCHS: 1500
  LR: 5.0e-5              # BASE_LR dal paper
  LR_BACKBONE: 1.0e-5     # BACKBONE_LR dal paper
  WEIGHT_DECAY: 1.0e-4
  SCHEDULER: "step"
  LR_DECAY_EPOCHS: 3500
  LR_DECAY_RATE: 0.9
  VAL_INTERVAL: 5
  RESUME_LAST: true
  EARLY_STOPPING_PATIENCE: 300
  GRAD_CLIP: 5.0          # CRITICO!

# === P2R LOSS ===
P2R_LOSS:
  MIN_RADIUS: 8
  MAX_RADIUS: 96
  COST_CLASS: 1
  COST_POINT: 8

# =================================================================
# STAGE 3 - JOINT (opzionale, da implementare per V2)
# =================================================================
OPTIM_JOINT:
  BATCH_SIZE: 8   
  NUM_WORKERS: 4
  EPOCHS: 500
  LR_BACKBONE: 1.0e-5
  LR_HEADS: 5.0e-6
  WEIGHT_DECAY: 1.0e-4
  VAL_INTERVAL: 5
  EARLY_STOPPING_PATIENCE: 150
  GRAD_CLIP: 5.0

JOINT_LOSS:
  FIXED_ZIP_WEIGHT: 0.1     
  FIXED_P2R_WEIGHT: 1.0     

# === BINS CONFIG (per ZIP) ===
BINS_CONFIG:
  shha:
    bins: [[0, 0], [1, 3], [4, 6], [7, 10], [11, 15], [16, 22], [23, 32], [33, 9999]]
    bin_centers: [0.0, 2.0, 5.0, 8.5, 13.0, 19.0, 27.5, 45.0]
  shhb:
    bins: [[0, 0], [1, 1], [2, 2], [3, 3], [4, 4], [5, 5], [6, 6], [7, 7], [8, 8], [9, 9999]]
    bin_centers: [0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 10.16]

EXP:
  OUT_DIR: "exp"
  SAVE_BEST: true